---
title: "TV Viewing Patterns - January 2025"
format: 
  html:
    embed-resources: true
    standalone: true
    theme: cosmo
    toc: false
---

```{r}
#| echo: false
#| message: false
#| warning: false

# Load required libraries
library(tidyverse)
library(quarto)
library(here)
library(readr)
library(plotly)
library(crosstalk)
library(htmltools)
library(lubridate)

# Load the sample data (first week of January)
viewingJan25 <- read_rds(here("viewingJan25_sample.rds"))

# Process datetime columns
viewingJan25 <- viewingJan25 |>
  mutate(
    view_date_parsed = ymd(view_date),
    start_time_formatted = str_replace(start_time, "^(\\d{2})(\\d{2})(\\d{2})$", "\\1:\\2:\\3"),
    end_time_formatted = str_replace(end_time, "^(\\d{2})(\\d{2})(\\d{2})$", "\\1:\\2:\\3"),
    start_datetime = ymd_hms(paste(view_date, start_time_formatted)),
    end_datetime = ymd_hms(paste(view_date, end_time_formatted))
  ) |>
  select(-start_time_formatted, -end_time_formatted)

# Create minute summary with platform information
minute_summary_with_platform <- viewingJan25 |>
  mutate(
    end_datetime_fixed = if_else(
      end_datetime < start_datetime, 
      end_datetime + days(1), 
      end_datetime
    ),
    # Add platform labels
    platform_label = case_when(
      V1 == "7012" ~ "STC TV",
      V1 == "7015" ~ "NETFLIX",
      V1 == "7017" ~ "SHAHID", 
      V1 == "7027" ~ "YOUTUBE",
      V1 == "7500" ~ "Other Players",
      V1 == "0" ~ "Linear TV",
      TRUE ~ paste0("Platform_", V1)
    )
  ) |>
  filter(!is.na(start_datetime), !is.na(end_datetime_fixed)) |>
  # Expand each session to cover all minutes it spans
  rowwise() |>
  mutate(
    minute_list = list(seq(
      floor_date(start_datetime, "minute"),
      floor_date(end_datetime_fixed, "minute"),
      by = "min"
    ))
  ) |>
  unnest(minute_list) |>
  ungroup() |>
  mutate(
    date = as.Date(minute_list),
    minute_time = format(minute_list, "%H:%M")
  ) |>
  # Aggregate by platform, minute, and date
  group_by(date, minute_time, platform_label) |>
  summarise(
    total_weight = sum(INDWgt, na.rm = TRUE),
    viewing_sessions = n(),
    .groups = "drop"
  )

# Create shared data object for filters
shared_minute_summary <- SharedData$new(
  minute_summary_with_platform, 
  key = ~paste(platform_label, minute_time, date)
)

# Create filters
date_filter <- filter_select(
  "date", 
  "Select Dates:", 
  shared_minute_summary, 
  ~date,
  multiple = TRUE
)

# Create platform filter with colored backgrounds
platform_filter_styled <- div(
  tags$style(HTML("
    .crosstalk-input-checkboxgroup .checkbox {
      margin-right: 15px;
      display: inline-block;
    }
    .crosstalk-input-checkboxgroup .checkbox label {
      font-weight: bold !important;
      padding: 4px 8px;
      border-radius: 4px;
      margin: 2px;
      color: white !important;
      text-shadow: 0px 1px 1px rgba(0,0,0,0.3);
    }
    .crosstalk-input-checkboxgroup .checkbox:has(input[value='STC TV']) label {
      background-color: #1f77b4 !important;
    }
    .crosstalk-input-checkboxgroup .checkbox:has(input[value='NETFLIX']) label {
      background-color: #ff7f0e !important;
    }
    .crosstalk-input-checkboxgroup .checkbox:has(input[value='SHAHID']) label {
      background-color: #2ca02c !important;
    }
    .crosstalk-input-checkboxgroup .checkbox:has(input[value='YOUTUBE']) label {
      background-color: #d62728 !important;
    }
    .crosstalk-input-checkboxgroup .checkbox:has(input[value='Other Players']) label {
      background-color: #9467bd !important;
    }
    .crosstalk-input-checkboxgroup .checkbox:has(input[value='Linear TV']) label {
      background-color: #8c564b !important;
    }
  ")),
  filter_checkbox(
    id = "platform",
    label = "Platforms:", 
    sharedData = shared_minute_summary,
    group = ~platform_label,
    inline = TRUE
  )
)

# Create stacked area plot
p <- shared_minute_summary |>
  plot_ly(
    x = ~minute_time, 
    y = ~total_weight, 
    color = ~platform_label,
    type = 'scatter',
    mode = 'none',
    fill = 'tonexty',
    stackgroup = 'one',
    hovertemplate = paste(
      "<b>Platform:</b> %{color}<br>",
      "<b>Time:</b> %{x}<br>", 
      "<b>Weight:</b> %{y:.2f}<br>",
      "<extra></extra>"
    )
  ) |>
  layout(
    title = "Total TV Viewing Weight by Platform and Time - January 2025 (First Week)",
    xaxis = list(
      title = "Time of Day",
      tickangle = -45
    ),
    yaxis = list(title = "Total Viewing Weight (Stacked)"),
    showlegend = FALSE,
    hovermode = 'closest'
  )

# Display the dashboard with styled filters
bscols(
  widths = c(12, 12),
  div(
    style = "margin-bottom: 20px;",
    h4("Filters"),
    div(style = "margin-bottom: 10px;", date_filter),
    platform_filter_styled
  ),
  p
)

```